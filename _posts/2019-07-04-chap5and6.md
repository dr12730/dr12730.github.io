---
title: 用户、权限与文件系统
date: 2019-07-04 09:36:59 +0800
description:
image:
  path: /assets/images/posts/2019-07-04-chap5and6/cover.jpg
  thumbnail: /assets/images/posts/2019-07-04-chap5and6/thumb.jpg
categories:
  - it
tags:
  - linux
---

Linux 在保证安全的前提下，可以让多个用户同时登陆系统工作。对于这样一个多用户多任务的系统，它是如何保证稳定与安全的呢。这一章就让我们来看看 Linux 是如何管理这些用户的吧

# 用户与权限

Linux 中有用户与用户组的概念，

## 用户及用户组

### 用户

linux 中的用户分成 3 类：

| 序号 | 用户       | UID     | 权限                                                                           |
| :--: | ---------- | ------- | ------------------------------------------------------------------------------ |
|  1   | 系统管理员 | 0       | 管理系统的用户                                                                 |
|  2   | 系统用户   | 1 ~ 999 | 系统的服务程序有独立的系统用户来运行，为避免某个系统服务被黑客提权到整个服务器 |
|  3   | 普通用户   | 1000 ~  | 由管理员创建的日常工作用户                                                     |

### 用户组

用户组是为了方便对用户权限的统一管理而设置的，在 linux 中创建一个用户就会创建一个与用户同名的基本用户组，把用户加入到其他用户组时，这个其他用户组称为扩展用户组。一个用户可以有一个基本用户组和多个扩展用户组。

### 常用命令

|------|----------|-------|----------------------------|
| 序号 | 命令 | 参数 | 功能 |
|------|----------|-------|----------------------------|
| 1 | useradd | -d | 指定用户的 home 目录 |
| | | -e | 账户的到期时间 |
| | | -u | 指定用户的 UID |
| | | -g | 指定用户的组 id |
| | | -G | 指定用户的扩展组 id |
| | | -s | 指定默认 shell |
| 2 | groupadd | 组名 | 创建用户组 |
| 3 | usermod | | 修改用户属性 |
| | | -c | 用户备注 |
| | | -d -m | 指定 home 目录并把文件移过去 |
| | | -L | 锁定、禁止登陆 |
| | | -U | 锁定、允许登陆 |
| | | -G | 修改扩展用户组 |
| | | -g | 修改基本用户组 |
| 4 | passwd | | 修改密码、锁定密码 |
| 5 | userdel | | 删除用户 |
| | | -r | 同时删除用户及 home 目录 |

### 示例

1. 创建一个普通用户，home 目录为 `/home/wilson`，`uid=8888`、`shell=/sbin/nologin`
   ```bash
   >>> useradd -d /home/wilson -u 8888 -s /sbin/nologin wilson
   >>> id linuxprobe
   uid=8888(linuxprobe) gid=8888(linuxprobe) groups=8888(linuxprobe)
   ```
2. 把 wilson 加入 root 用户组
   ```bash
   >>> id wilson
   uid=1000(linuxprobe) gid=1000(linuxprobe) groups=1000(linuxprobe)
   >>> usermod -G root wilson
   uid=1000(linuxprobe) gid=1000(linuxprobe) groups=1000(linuxprobe),0(root)
   ```
3. 删除用户及目录
   ```bash
   >>> userdel -r wilson
   ```

## 文件权限及归属

### 文件类型

linux 一切是文件，但也分成不同类型：

|------|------|--------------|
| 序号 | 标识 | 类型 |
|------|------|--------------|
| 1 | `-` | 普通文件 |
| 2 | `d` | 目录文件 |
| 3 | `l` | 链接文件 |
| 4 | `b` | 块设备文件 |
| 5 | `c` | 字符设备文件 |
| 6 | `p` | 管道文件 |
|------|------|--------------|

### 文件基本权限

#### 基本标识

|------|------|--------------------|----------------------------|
| 序号 | 标识 | 文件 | 目录 |
|------|------|--------------------|----------------------------|
| 1 | `r` | 可读取内容 | 可读取目录中的文件列表 |
| 2 | `w` | 可增、删、改内容 | 可在目录中增、删、改文件名 |
| 3 | `x` | 可运行一个脚本程序 | 可进入目录 |
|------|------|--------------------|----------------------------|

### 文件归属

一个文件归属包括：所有者、所有组和其他用户，

### 文件的特殊权限

|------|------------------------------------------------------------------------------------|
| 权限 | 说明 |
|------|------------------------------------------------------------------------------------|
| suid | 上方宝剑，临时拥有管理员权限 |
| sgid | 1. 对文件：让执行者有文件属组权限<br>2. 对目录：目录中创建的文件自动继承目录用户组 |
| sbit | 粘滞位/保护位，只能删除自己文件不能删除别人文件 |
|------|------------------------------------------------------------------------------------|

> 删除文件的权限在于用户对目录文件是否有写入权限，

#### chmod 和 chown

|-------|----------------------------|------------------------------------------------------|
| 命令 | 功能 | 格式 |
|-------|----------------------------|------------------------------------------------------|
| chmod | 设置文件或目录的基本权限 | chmod 777 abc |
| chown | 设置文件或目录的属主和属组 | chown 属主:属组 文件/目录(-R)<br>chown root:bin test |
|-------|----------------------------|------------------------------------------------------|

#### 示例

1. 执行者拥有属组权限
   ```bash
   >>> ls -l /dev/kmem
   cr--r-----   1 root system 2,  1 Feb 11 2017  kmem
   # kmem 只有 root 和 system 组可以读取
   # 用户通过 ps 命令查看 kmem 内容
   >>> -ls -l ps
   -r-xr-sr-x   1 bin system 59346 Feb 11 2017  ps
   # ps 命令具有sgid权限，用户执行ps时，会具有system组权限
   ```
2. 部门内设置共享目录，员工可在目录中创建和读取文件
   ```bash
   >>> mkdir department
   # 让所有员工都可以读、写
   >>> chmod -Rf department
   # 增加sgid，目录中员工创建的文件自动继承目录组权限
   >>> chown -Rf g+s department
   # 这样普通用户在 department 中创建的文件自动继承了它的组
   ```
3. 对目录设置保护位
   ```bash
   >>> chmod -R o+t linux/
   ```

### 文件的隐藏权限

#### 命令

|--------|--------------------|------------------------------------|
| 命令 | 格式/参数 | 说明 |
|--------|--------------------|------------------------------------|
| chattr | chattr [参数] 文件 | `+参数` 增加权限；`-参数` 删除权限 |
| | -a | 只能添加，不能删除 |
| lsattr | lsattr [参数] 文件 | 显示文件的隐藏属性 |
|--------|--------------------|------------------------------------|

#### 示例

1. 普通用户创建目录，设置不能删除
   ```bash
   >>> touch test
   >>> chattr +a test
   ```
2. 显示文件的隐藏属性
   ```bash
   [root@linuxprobe ~]# lsattr linuxprobe
   -----a---------- linuxprobe
   [root@linuxprobe ~]# chattr -a linuxprobe
   [root@linuxprobe ~]# lsattr linuxprobe
   ---------------- linuxprobe
   ```

### 文件访问控制列表 FACL

#### 特性

- 针对某个特定用户或者特定的用户组设置文件或目录的操作权限，就要用到文件访问控制列表(FACL)
- 对目录设置了 FACL，则目录中的文件都继承其 FACL
- 对文件设置 FACL，则文件不再继承目录的 FACL

#### 命令

|---------|--------------------------|-------------------------------|
| 命令 | 参数 | 说明 |
|---------|--------------------------|-------------------------------|
| setfacl | setfacl [参数] 文件/目录 | 针对特定用户/组设置的操作权限 |
| | -R | 目录 |
| | -m | 文件 |
| | -b | 删除 FACL |
| getfacl | getfacl 文件/目录 | 查看 FACL |
|---------|--------------------------|-------------------------------|

#### 示例

1. 让 wilson 有查看 root 目录的权限
   ```bash
   >>> setfacl -Rm u:wilson:rwx /root
   >>> su - wilson
   Last login: Sat Mar 21 15:45:03 CST 2017 on pts/1
   >>> ls /root
   anaconda-ks.cfg Downloads Pictures Public
   >>> ls -ld /root
   dr-xrwx---+ 14 root root 4096 May 4 2017 /root
   # 文件权限的 . 变成了 + 说明设置了 FACL
   ```
2. 查看 FACL
   ```bash
   >>> getfacl /root
   getfacl: Removing leading '/' from absolute path names
   # file: root
   # owner: root
   # group: root
   user::r-x
   user:wilson:rwx
   group::r-x
   mask::rwx
   other::---
   ```

### su 命令与 sudo 服务

|--------|------|--------------------------------------------|
| 命令 | 参数 | 说明 |
|--------|------|--------------------------------------------|
| su | | 让用户在不退出登陆的情况下，切换到其他用户 |
| | - | 完全切换，把环境变量信息也变更 |
| sudo | | 提供额外的权限来完成 root 任务 |
| | -l | 列出当前用户可执行的命令 |
| visudo | | 编辑 sudo 服务的配置文件 |
|--------|------|--------------------------------------------|

#### sudo 特点

- 限制用户执行指定的命令
- 记录用户执行的每一条命令
- 配置文件（/etc/sudoers）提供集中的用户管理、权限与主机等参数
- 验证密码的后 5 分钟内（默认值）无须再让用户再次验证密码

#### visudo

格式： **谁可以使用 允许使用的主机=(以谁的身份) 可执行命令的列表**

```bash
visudo
96 ##
97 ## Allow root to run any commands anywhere
98 root ALL=(ALL) ALL
# wilson可以执行所有root命令，只需输入自己的密码
99 wilson ALL=(ALL) ALL
# 只能以root权限执行cat
100 linuxprobe ALL=(ALL) /usr/bin/cat
# 执行时不需输入密码
101 tom ALL=NOPASSWD: /usr/sbin/poweroff
```
